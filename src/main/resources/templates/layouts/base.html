<!doctype html>
<html lang="en" data-theme="dark" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Title -->
    <title th:text="${pageTitle ?: 'Car Builder VIN System'}">Car Builder VIN System</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš¡</text></svg>">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" th:href="@{/pico-main/css/pico.min.css}">
    <link rel="stylesheet" th:href="@{/css/jarvis-theme.css}">
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.3"></script>
    
    <!-- Additional head content -->
    <th:block layout:fragment="head"></th:block>
    
    <style>
        /* Loading indicator for HTMX requests */
        .global-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, 
                transparent, 
                var(--jarvis-glow-color), 
                var(--jarvis-accent-color),
                transparent
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            display: none;
            z-index: 9999;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
    </style>
</head>

<body>
    <!-- Global loading indicator -->
    <div class="global-loading"></div>
    
    <!-- Navigation -->
    <nav class="navbar" th:replace="~{fragments/navigation :: navbar}"></nav>
    
    <!-- Main Content -->
    <main class="container" layout:fragment="content">
        <!-- Page content will be inserted here -->
    </main>
    
    <!-- Footer -->
    <footer class="container" style="margin-top: 3rem; padding: 2rem 0; border-top: 1px solid var(--muted-border-color); text-align: center; color: var(--muted-color);">
        <div class="grid">
            <div>
                <p>
                    <small>
                        Car Builder VIN System &copy; 2024 Sentinovo
                        <br>
                        <span class="text-jarvis">Powered by Jarvis Interface Technology</span>
                    </small>
                </p>
            </div>
            <div style="text-align: right;">
                <p>
                    <small>
                        <span class="system-status operational">
                            <span class="status-indicator"></span>
                            System Status: <span th:text="${systemStatus ?: 'ONLINE'}">ONLINE</span>
                        </span>
                    </small>
                </p>
            </div>
        </div>
    </footer>
    
    <!-- Scripts -->
    <script th:src="@{/js/app.js}"></script>
    
    <!-- Additional scripts -->
    <th:block layout:fragment="scripts"></th:block>
    
    <!-- HTMX Configuration -->
    <script>
        // Configure HTMX defaults
        htmx.config.globalViewTransitions = true;
        htmx.config.refreshOnHistoryMiss = true;
        
        // Add CSRF token to all HTMX requests if available
        document.body.addEventListener('htmx:configRequest', function(evt) {
            const csrfToken = document.querySelector('meta[name="_csrf"]');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]');
            
            if (csrfToken && csrfHeader) {
                evt.detail.headers[csrfHeader.getAttribute('content')] = csrfToken.getAttribute('content');
            }
        });
        
        // Show notifications for common HTTP responses
        document.body.addEventListener('htmx:responseError', function(evt) {
            const status = evt.detail.xhr.status;
            let message = 'An error occurred';
            
            switch(status) {
                case 400:
                    message = 'Invalid request. Please check your input.';
                    break;
                case 401:
                    message = 'Authentication required. Please login.';
                    break;
                case 403:
                    message = 'Access denied. Insufficient permissions.';
                    break;
                case 404:
                    message = 'Resource not found.';
                    break;
                case 500:
                    message = 'Server error. Please try again later.';
                    break;
                default:
                    message = `Server responded with status ${status}`;
            }
            
            window.CarBuilderVIN?.showNotification?.(message, 'error');
        });
    </script>
</body>
</html>